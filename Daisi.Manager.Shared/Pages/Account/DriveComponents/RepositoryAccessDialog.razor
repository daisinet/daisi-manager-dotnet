@using Daisi.Protos.V1
@using Daisi.SDK.Clients.V1.Orc

<div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fa-duotone fa-users me-2"></i> Repository Access - @Repository.Name
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="OnClose"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <span class="badge @GetRepoTypeBadge(Repository.Type) me-2">@Repository.Type</span>
                    <small class="text-secondary">@GetAccessDescription()</small>
                </div>

                @* Current Access List *@
                <h6 class="mt-3 mb-2">Current Access</h6>
                @if (Repository.AccessList.Any())
                {
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in Repository.AccessList)
                            {
                                <tr>
                                    <td>
                                        <i class="fa-duotone @(entry.IsApp ? "fa-robot" : "fa-user") me-1"></i>
                                        @entry.UserName
                                    </td>
                                    <td>
                                        <span class="badge @(entry.IsApp ? "bg-warning text-dark" : "bg-info")">
                                            @(entry.IsApp ? "App" : "User")
                                        </span>
                                    </td>
                                    <td>
                                        @if (CanManageAccess)
                                        {
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => RevokeAccess(entry)" disabled="@_processing">
                                                <i class="fa-duotone fa-user-minus me-1"></i> Revoke
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="text-secondary mb-3">
                        <i class="fa-duotone fa-info-circle me-1"></i>
                        @if (Repository.Type == RepositoryType.Account)
                        {
                            @:All team members have access to this repository.
                        }
                        else if (Repository.Type == RepositoryType.Private)
                        {
                            @:Only the owner has access to this repository.
                        }
                        else
                        {
                            @:No users have been granted explicit access.
                        }
                    </div>
                }

                @* Grant Access Form (Custom repos only, Managers/Owners or creator) *@
                @if (CanManageAccess)
                {
                    <hr class="border-secondary" />
                    <h6 class="mb-2">Grant Access</h6>
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label">Type</label>
                            <select class="form-select" @bind="_grantType">
                                <option value="User">User</option>
                                <option value="App">App</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">@(_grantType == "User" ? "Select User" : "Select App")</label>
                            @if (_grantType == "User")
                            {
                                <select class="form-select" @bind="_selectedUserId">
                                    <option value="">-- Select a user --</option>
                                    @foreach (var user in AvailableUsers)
                                    {
                                        <option value="@user.Id">@user.Name (@user.EmailAddress)</option>
                                    }
                                </select>
                            }
                            else
                            {
                                <select class="form-select" @bind="_selectedAppId">
                                    <option value="">-- Select an app --</option>
                                    @foreach (var app in AvailableApps)
                                    {
                                        <option value="@app.Id">@app.Name (@app.Type)</option>
                                    }
                                </select>
                            }
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-success w-100" @onclick="GrantAccess"
                                    disabled="@(!CanGrant || _processing)">
                                <i class="fa-duotone fa-user-plus me-1"></i> Grant
                            </button>
                        </div>
                    </div>
                    @if (AvailableUsers.Count == 0 && _grantType == "User")
                    {
                        <small class="text-secondary mt-2 d-block">All users already have access to this repository.</small>
                    }
                    @if (AvailableApps.Count == 0 && _grantType == "App")
                    {
                        <small class="text-secondary mt-2 d-block">All apps already have access to this repository.</small>
                    }
                }
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" @onclick="OnClose">Close</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public DriveRepository Repository { get; set; } = new();
    [Parameter] public List<User> Users { get; set; } = [];
    [Parameter] public List<Dapp> Apps { get; set; } = [];
    [Parameter] public UserRoles? CurrentUserRole { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    [Inject] DriveClientFactory DriveClientFactory { get; set; } = default!;
    [Inject] IToastService ToastService { get; set; } = default!;

    string _grantType = "User";
    string _selectedUserId = "";
    string _selectedAppId = "";
    bool _processing = false;

    bool CanManageAccess => Repository.Type == RepositoryType.Custom
        && CurrentUserRole >= UserRoles.Manager;

    bool CanGrant => _grantType == "User"
        ? !string.IsNullOrEmpty(_selectedUserId)
        : !string.IsNullOrEmpty(_selectedAppId);

    // Filter out users who already have access
    List<User> AvailableUsers => Users
        .Where(u => u.Role >= UserRoles.Manager
            && !Repository.AccessList.Any(a => a.UserId == u.Id && !a.IsApp))
        .ToList();

    // Filter out apps who already have access
    List<Dapp> AvailableApps => Apps
        .Where(a => !Repository.AccessList.Any(ra => ra.UserId == a.Id && ra.IsApp))
        .ToList();

    string GetAccessDescription() => Repository.Type switch
    {
        RepositoryType.Account => "All team members have access. Managers and above can manage content.",
        RepositoryType.Private => "Only the owner can access files in this repository.",
        RepositoryType.Custom => "Access is granted to specific users and apps listed below.",
        _ => ""
    };

    string GetRepoTypeBadge(RepositoryType type) => type switch
    {
        RepositoryType.Account => "bg-primary",
        RepositoryType.Private => "bg-info",
        RepositoryType.Custom => "bg-success",
        RepositoryType.Trash => "bg-danger",
        _ => "bg-secondary"
    };

    async Task GrantAccess()
    {
        if (!CanGrant) return;
        _processing = true;

        try
        {
            var driveClient = DriveClientFactory.Create();
            bool isApp = _grantType == "App";
            string userId, userName;

            if (isApp)
            {
                var app = Apps.FirstOrDefault(a => a.Id == _selectedAppId);
                if (app is null) return;
                userId = app.Id;
                userName = app.Name;
            }
            else
            {
                var user = Users.FirstOrDefault(u => u.Id == _selectedUserId);
                if (user is null) return;
                userId = user.Id;
                userName = user.Name;
            }

            var result = await driveClient.GrantRepositoryAccessAsync(Repository.Id, userId, userName, isApp);
            if (result.Success)
            {
                Repository.AccessList.Add(new RepositoryAccess
                {
                    UserId = userId,
                    UserName = userName,
                    IsApp = isApp
                });
                ToastService.ShowSuccess($"Access granted to {userName}.");
                _selectedUserId = "";
                _selectedAppId = "";
            }
            else
            {
                ToastService.ShowError($"Error: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error granting access: {ex.Message}");
        }

        _processing = false;
    }

    async Task RevokeAccess(RepositoryAccess entry)
    {
        _processing = true;

        try
        {
            var driveClient = DriveClientFactory.Create();
            var result = await driveClient.RevokeRepositoryAccessAsync(Repository.Id, entry.UserId);
            if (result.Success)
            {
                Repository.AccessList.Remove(entry);
                ToastService.ShowSuccess($"Access revoked for {entry.UserName}.");
            }
            else
            {
                ToastService.ShowError($"Error: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error revoking access: {ex.Message}");
        }

        _processing = false;
    }
}
