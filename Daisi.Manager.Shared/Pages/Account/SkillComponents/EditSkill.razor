@page "/account/manage/skills/new"
@page "/account/manage/skills/{Id}"
@using Daisi.Manager.Shared.Services

<h2>@(IsEdit ? "Edit Skill" : "Create New Skill")</h2>

<div class="row">
    <div class="col-md-8">
        <div class="mb-3">
            <label class="form-label">Skill Name</label>
            <input type="text" class="form-control" @bind="_name" />
        </div>

        <div class="mb-3">
            <label class="form-label">Short Description</label>
            <input type="text" class="form-control" @bind="_shortDescription" maxlength="120" />
            <small class="text-muted">Max 120 characters</small>
        </div>

        <div class="mb-3">
            <label class="form-label">Version</label>
            <input type="text" class="form-control" @bind="_version" style="max-width: 200px;" />
        </div>

        <div class="mb-3">
            <label class="form-label">Full Description (Markdown)</label>
            <textarea class="form-control" rows="8" @bind="_description"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Tags (comma-separated)</label>
            <input type="text" class="form-control" @bind="_tagsInput" />
        </div>

        <div class="mb-3">
            <label class="form-label">Required Tool Groups</label>
            @foreach (var group in _allToolGroups)
            {
                var isChecked = _requiredToolGroups.Contains(group);
                var isElevated = _elevatedGroups.Contains(group);
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" checked="@isChecked"
                           @onchange="@(e => ToggleToolGroup(group, (bool)(e.Value ?? false)))" />
                    <label class="form-check-label">
                        @group
                        @if (isElevated)
                        {
                            <span class="badge bg-warning text-dark ms-1">Elevated</span>
                        }
                    </label>
                </div>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">System Prompt Template</label>
            <textarea class="form-control" rows="6" @bind="_systemPromptTemplate"
                      placeholder="The prompt injected when this skill is active..."></textarea>
            <small class="text-muted">This prompt will be added to the agent's system prompt when this skill is enabled.</small>
        </div>

        <div class="mb-3">
            <label class="form-label">Visibility</label>
            <select class="form-select" @bind="_visibility">
                <option value="Private">Private (your account only)</option>
                <option value="Public">Public (requires DAISI employee approval)</option>
            </select>
        </div>

        <div class="d-flex gap-2 mt-4">
            <button class="btn btn-primary" @onclick="SaveAsync" disabled="@_saving">
                @if (_saving) { <span class="spinner-border spinner-border-sm"></span> }
                Save
            </button>

            @if (IsEdit && _status is "Draft" or "Rejected" && _visibility == "Public")
            {
                <button class="btn btn-warning" @onclick="SubmitForReviewAsync">Submit for Review</button>
            }

            <a href="/account/manage/skills" class="btn btn-outline-secondary">Cancel</a>
        </div>

        @if (!string.IsNullOrEmpty(_error))
        {
            <div class="alert alert-danger mt-3">@_error</div>
        }
        @if (!string.IsNullOrEmpty(_success))
        {
            <div class="alert alert-success mt-3">@_success</div>
        }

        @if (IsEdit && !string.IsNullOrEmpty(_rejectionReason))
        {
            <div class="alert alert-warning mt-3">
                <strong>Rejection Reason:</strong> @_rejectionReason
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public string? Id { get; set; }

    [Inject] public SkillClientFactory SkillClientFactory { get; set; } = default!;
    [Inject] public AuthService AuthService { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    private bool IsEdit => !string.IsNullOrEmpty(Id);

    // Editable fields (bound to form inputs)
    private string _name = string.Empty;
    private string _shortDescription = string.Empty;
    private string _version = "1.0.0";
    private string _description = string.Empty;
    private string _tagsInput = string.Empty;
    private List<string> _requiredToolGroups = [];
    private string _systemPromptTemplate = string.Empty;
    private string _visibility = "Private";
    private string _status = "Draft";
    private string _rejectionReason = string.Empty;

    // The full proto object (only populated on edit)
    private SkillInfo? _existingSkill;

    private bool _saving;
    private string _error = string.Empty;
    private string _success = string.Empty;

    private static readonly string[] _allToolGroups =
        ["InformationTools", "FileTools", "MathTools", "CommunicationTools", "CodingTools", "MediaTools", "IntegrationTools", "SocialTools"];

    private static readonly HashSet<string> _elevatedGroups = ["FileTools", "CommunicationTools", "IntegrationTools"];

    protected override async Task OnParametersSetAsync()
    {
        if (IsEdit)
        {
            var client = SkillClientFactory.Create();
            var response = await client.GetSkillByIdAsync(new GetSkillByIdRequest { Id = Id! });
            if (response.Skill is not null)
            {
                _existingSkill = response.Skill;
                _name = _existingSkill.Name;
                _shortDescription = _existingSkill.ShortDescription;
                _version = _existingSkill.Version;
                _description = _existingSkill.Description;
                _tagsInput = string.Join(", ", _existingSkill.Tags);
                _requiredToolGroups = _existingSkill.RequiredToolGroups.ToList();
                _systemPromptTemplate = _existingSkill.SystemPromptTemplate;
                _visibility = _existingSkill.Visibility;
                _status = _existingSkill.Status;
                _rejectionReason = _existingSkill.RejectionReason;
            }
        }
    }

    private void ToggleToolGroup(string group, bool enabled)
    {
        if (enabled && !_requiredToolGroups.Contains(group))
            _requiredToolGroups.Add(group);
        else if (!enabled)
            _requiredToolGroups.Remove(group);
    }

    private async Task SaveAsync()
    {
        _saving = true;
        _error = string.Empty;
        _success = string.Empty;

        try
        {
            var accountId = await AuthService.GetAccountIdAsync() ?? string.Empty;
            var author = await AuthService.GetUserNameAsync() ?? string.Empty;
            var tags = _tagsInput.Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(t => t.Trim()).Where(t => !string.IsNullOrEmpty(t)).ToList();

            var client = SkillClientFactory.Create();

            if (IsEdit && _existingSkill is not null)
            {
                _existingSkill.Name = _name;
                _existingSkill.ShortDescription = _shortDescription;
                _existingSkill.Version = _version;
                _existingSkill.Description = _description;
                _existingSkill.RequiredToolGroups.Clear();
                _existingSkill.RequiredToolGroups.AddRange(_requiredToolGroups);
                _existingSkill.Tags.Clear();
                _existingSkill.Tags.AddRange(tags);
                _existingSkill.SystemPromptTemplate = _systemPromptTemplate;
                _existingSkill.Visibility = _visibility;
                _existingSkill.Author = author;

                await client.UpdateSkillAsync(new UpdateSkillRequest { Skill = _existingSkill });
                _success = "Skill updated successfully.";
            }
            else
            {
                var request = new CreateSkillRequest
                {
                    AccountId = accountId,
                    Name = _name,
                    ShortDescription = _shortDescription,
                    Version = _version,
                    Description = _description,
                    SystemPromptTemplate = _systemPromptTemplate,
                    Visibility = _visibility,
                    Author = author
                };
                request.RequiredToolGroups.AddRange(_requiredToolGroups);
                request.Tags.AddRange(tags);

                await client.CreateSkillAsync(request);
                _success = "Skill created successfully.";
                Navigation.NavigateTo("/account/manage/skills");
            }
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }

        _saving = false;
    }

    private async Task SubmitForReviewAsync()
    {
        if (_existingSkill is null) return;

        _existingSkill.Status = "PendingReview";
        var client = SkillClientFactory.Create();
        await client.UpdateSkillAsync(new UpdateSkillRequest { Skill = _existingSkill });
        _status = "PendingReview";
        _success = "Skill submitted for review.";
    }
}
