
<div class="px-4 pb-4">
    <Daisi.Razor.Components.Validation.ValidationAlert Messages=messages></Daisi.Razor.Components.Validation.ValidationAlert>

    <div class="">
        <label class="fw-bold">Release Group *</label>
        <select class="form-control" @bind="releaseGroup">
            <option value="">-- Select Group --</option>
            <option value="beta">beta</option>
            <option value="group1">group1</option>
            <option value="group2">group2</option>
            <option value="production">production</option>
        </select>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Version *</label>
        <p>The version identifier for this release (e.g. 1.2.3).</p>
        <input class="form-control" @bind="version" />
    </div>
    <div class="mt-3">
        <label class="fw-bold">Download URL *</label>
        <p>The URL where hosts can download this release.</p>
        <input class="form-control" @bind="downloadUrl" />
    </div>
    <div class="mt-3">
        <label class="fw-bold">Release Notes</label>
        <textarea class="form-control" rows="3" @bind="releaseNotes"></textarea>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Required Orc Version</label>
        <p>Minimum Orc version required for this release.</p>
        <input class="form-control" @bind="requiredOrcVersion" />
    </div>
    <div class="mt-3">
        <label class="fw-bold">Activate Immediately</label>
        <MudSwitch Color="Color.Success" UncheckedColor="Color.Default" @bind-Value="activateImmediately" Label=@(activateImmediately ? "Will activate on create" : "Will not activate on create")></MudSwitch>
    </div>
    <div class="mt-3">
        <button class="btn btn-success" disabled="@processing" @onclick="OnSave">Create</button>
    </div>
</div>

@code {
    [Inject] public ReleaseClientFactory ReleaseClientFactory { get; set; }
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; }

    string releaseGroup = "";
    string version = "";
    string downloadUrl = "";
    string releaseNotes = "";
    string requiredOrcVersion = "";
    bool activateImmediately = false;
    bool processing = false;
    List<string> messages = new();

    async Task OnSave()
    {
        messages = new();

        if (string.IsNullOrWhiteSpace(releaseGroup))
            messages.Add("Release Group is required.");

        if (string.IsNullOrWhiteSpace(version))
            messages.Add("Version is required.");

        if (string.IsNullOrWhiteSpace(downloadUrl))
            messages.Add("Download URL is required.");

        if (messages.Any())
            return;

        processing = true;

        try
        {
            var client = ReleaseClientFactory.Create();
            var request = new CreateReleaseRequest
            {
                ReleaseGroup = releaseGroup,
                Version = version,
                DownloadUrl = downloadUrl,
                Activate = activateImmediately
            };

            if (!string.IsNullOrWhiteSpace(releaseNotes))
                request.ReleaseNotes = releaseNotes;

            if (!string.IsNullOrWhiteSpace(requiredOrcVersion))
                request.RequiredOrcVersion = requiredOrcVersion;

            var response = await client.CreateAsync(request);

            if (response.Release is null)
            {
                messages.Add("An error occurred while creating the release.");
                processing = false;
                return;
            }

            if (MudDialog is not null)
                MudDialog.Close<HostReleaseInfo>(response.Release);
        }
        catch (Exception ex)
        {
            messages.Add($"An error occurred: {ex.Message}");
        }

        processing = false;
    }
}
