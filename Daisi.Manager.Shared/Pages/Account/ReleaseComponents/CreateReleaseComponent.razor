
<div class="px-4 pb-4">
    <Daisi.Razor.Components.Validation.ValidationAlert Messages=messages></Daisi.Razor.Components.Validation.ValidationAlert>

    <div class="">
        <label class="fw-bold">Release Group *</label>
        <select class="form-control" @bind="releaseGroup">
            <option value="">-- Select Group --</option>
            <option value="beta">beta</option>
            <option value="group1">group1</option>
            <option value="group2">group2</option>
            <option value="production">production</option>
        </select>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Release Notes</label>
        <textarea class="form-control" rows="3" @bind="releaseNotes"></textarea>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Activate Immediately</label>
        <MudSwitch Color="Color.Success" UncheckedColor="Color.Default" @bind-Value="activateImmediately" Label=@(activateImmediately ? "Will activate on deploy" : "Will not activate on deploy")></MudSwitch>
    </div>
    <div class="mt-3 text-secondary small">
        <p class="mb-1">This will trigger the full release pipeline:</p>
        <ul class="mb-0">
            <li>Check &amp; publish SDK (if source changed)</li>
            <li>Deploy ORC to Azure</li>
            <li>Build &amp; release Host (blob upload + DB record)</li>
        </ul>
    </div>
    <div class="mt-3">
        <button class="btn btn-success" disabled="@processing" @onclick="OnStartRelease">
            @if (processing)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Starting...</span>
            }
            else
            {
                <span>Start Release</span>
            }
        </button>
    </div>
</div>

@code {
    [Inject] public ReleaseClientFactory ReleaseClientFactory { get; set; }
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; }

    string releaseGroup = "";
    string releaseNotes = "";
    bool activateImmediately = true;
    bool processing = false;
    List<string> messages = new();

    async Task OnStartRelease()
    {
        messages = new();

        if (string.IsNullOrWhiteSpace(releaseGroup))
            messages.Add("Release Group is required.");

        if (messages.Any())
            return;

        processing = true;

        try
        {
            var client = ReleaseClientFactory.Create();
            var request = new TriggerReleaseRequest
            {
                ReleaseGroup = releaseGroup,
                Activate = activateImmediately
            };

            if (!string.IsNullOrWhiteSpace(releaseNotes))
                request.ReleaseNotes = releaseNotes;

            var response = await client.TriggerReleaseAsync(request);

            if (!response.Success)
            {
                messages.Add(response.ErrorMessage ?? "An unknown error occurred while triggering the release.");
                processing = false;
                return;
            }

            if (MudDialog is not null)
                MudDialog.Close(response.Version);
        }
        catch (Exception ex)
        {
            messages.Add($"An error occurred: {ex.Message}");
        }

        processing = false;
    }
}
