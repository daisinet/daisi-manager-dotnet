
<div class="px-4 pb-4">
    <Daisi.Razor.Components.Validation.ValidationAlert Messages=messages></Daisi.Razor.Components.Validation.ValidationAlert>

    <div class="">
        <label class="fw-bold">Release Group *</label>
        <select class="form-control" @bind="releaseGroup">
            <option value="">-- Select Group --</option>
            <option value="beta">beta</option>
            <option value="group1">group1</option>
            <option value="group2">group2</option>
            <option value="production">production</option>
        </select>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Release Notes</label>
        <textarea class="form-control" rows="3" @bind="releaseNotes"></textarea>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Required Orc Version</label>
        <p class="text-secondary small mb-1">Minimum Orc version hosts must be connected to for this release.</p>
        @if (loadingOrcs)
        {
            <select class="form-control" disabled><option>Loading versions...</option></select>
        }
        else
        {
            <select class="form-control" @bind="requiredOrcVersion">
                <option value="">-- None --</option>
                @foreach (var v in orcVersions)
                {
                    <option value="@v">@v</option>
                }
            </select>
        }
    </div>
    <div class="mt-3">
        <label class="fw-bold">Activate Immediately</label>
        <MudSwitch Color="Color.Success" UncheckedColor="Color.Default" @bind-Value="activateImmediately" Label=@(activateImmediately ? "Will activate on create" : "Will not activate on create")></MudSwitch>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Version</label>
        <p class="form-control-plaintext">@version</p>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Download URL</label>
        <p class="form-control-plaintext text-break">@downloadUrl</p>
    </div>
    <div class="mt-3">
        <button class="btn btn-success" disabled="@processing" @onclick="OnSave">Create</button>
    </div>
</div>

@code {
    [Inject] public ReleaseClientFactory ReleaseClientFactory { get; set; }
    [Inject] public OrcClientFactory OrcClientFactory { get; set; }
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; }

    string releaseGroup = "";
    string version = "";
    string releaseNotes = "";
    string requiredOrcVersion = "";
    bool activateImmediately = true;
    bool processing = false;
    bool loadingOrcs = true;
    List<string> messages = new();
    List<string> orcVersions = new();

    string downloadUrl => $"https://daisi.blob.core.windows.net/releases/{version}/latest-desktop.zip";

    protected override async Task OnInitializedAsync()
    {
        version = DateTime.UtcNow.ToString("yyyy.MM.dd.HHmm");

        try
        {
            var client = OrcClientFactory.Create();
            var response = await client.GetAsync(new GetOrcsRequest { Paging = new PagingInfo { PageSize = 100 } });
            orcVersions = response.Orcs
                .Where(o => !string.IsNullOrWhiteSpace(o.Version))
                .Select(o => o.Version)
                .Distinct()
                .OrderByDescending(v => v)
                .ToList();

            if (orcVersions.Any())
                requiredOrcVersion = orcVersions.First();
        }
        catch { }

        loadingOrcs = false;
    }

    async Task OnSave()
    {
        messages = new();

        if (string.IsNullOrWhiteSpace(releaseGroup))
            messages.Add("Release Group is required.");

        if (messages.Any())
            return;

        processing = true;

        try
        {
            var client = ReleaseClientFactory.Create();
            var request = new CreateReleaseRequest
            {
                ReleaseGroup = releaseGroup,
                Version = version,
                DownloadUrl = downloadUrl,
                Activate = activateImmediately
            };

            if (!string.IsNullOrWhiteSpace(releaseNotes))
                request.ReleaseNotes = releaseNotes;

            if (!string.IsNullOrWhiteSpace(requiredOrcVersion))
                request.RequiredOrcVersion = requiredOrcVersion;

            var response = await client.CreateAsync(request);

            if (response.Release is null)
            {
                messages.Add("An error occurred while creating the release.");
                processing = false;
                return;
            }

            if (MudDialog is not null)
                MudDialog.Close<HostReleaseInfo>(response.Release);
        }
        catch (Exception ex)
        {
            messages.Add($"An error occurred: {ex.Message}");
        }

        processing = false;
    }
}
