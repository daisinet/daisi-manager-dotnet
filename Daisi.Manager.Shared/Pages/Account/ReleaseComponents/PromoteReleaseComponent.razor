
<div class="px-4 pb-4">
    <Daisi.SDK.Razor.Components.Validation.ValidationAlert Messages=messages></Daisi.SDK.Razor.Components.Validation.ValidationAlert>

    <div class="">
        <label class="fw-bold">Source</label>
        <p class="form-control-plaintext">@SourceRelease.Version â€” <span class="badge border border-info">@SourceRelease.ReleaseGroup</span></p>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Target Group *</label>
        <select class="form-control" @bind="targetGroup">
            <option value="">-- Select Group --</option>
            @foreach (var g in availableGroups)
            {
                <option value="@g">@g</option>
            }
        </select>
    </div>
    <div class="mt-3">
        <label class="fw-bold">Activate Immediately</label>
        <MudSwitch Color="Color.Success" UncheckedColor="Color.Default" @bind-Value="activateImmediately" Label=@(activateImmediately ? "Will activate on promote" : "Will not activate on promote")></MudSwitch>
    </div>
    <div class="mt-3">
        <button class="btn btn-success" disabled="@processing" @onclick="OnPromote">Promote</button>
    </div>
</div>

@code {
    [Inject] public ReleaseClientFactory ReleaseClientFactory { get; set; }
    [CascadingParameter] public IMudDialogInstance MudDialog { get; set; }
    [Parameter] public HostReleaseInfo SourceRelease { get; set; }

    string targetGroup = "";
    bool activateImmediately = true;
    bool processing = false;
    List<string> messages = new();

    static readonly string[] releaseGroups = ["beta", "group1", "group2", "production"];

    List<string> availableGroups = new();

    protected override void OnInitialized()
    {
        availableGroups = releaseGroups
            .Where(g => g != SourceRelease.ReleaseGroup)
            .ToList();
    }

    async Task OnPromote()
    {
        messages = new();

        if (string.IsNullOrWhiteSpace(targetGroup))
            messages.Add("Target Group is required.");

        if (messages.Any())
            return;

        processing = true;

        try
        {
            // Trigger a full release build for the target group.
            // This builds Velopack packages with the correct channel and uploads them
            // to blob storage, then creates the DB release record.
            var client = ReleaseClientFactory.Create();
            var request = new TriggerReleaseRequest
            {
                ReleaseGroup = targetGroup,
                Activate = activateImmediately
            };

            if (!string.IsNullOrWhiteSpace(SourceRelease.ReleaseNotes))
                request.ReleaseNotes = SourceRelease.ReleaseNotes;

            var response = await client.TriggerReleaseAsync(request);

            if (!response.Success)
            {
                messages.Add(response.ErrorMessage ?? "Failed to trigger release pipeline.");
                processing = false;
                return;
            }

            // Return a placeholder release info so the UI can update
            var releaseInfo = new HostReleaseInfo
            {
                ReleaseGroup = targetGroup,
                Version = response.Version,
                IsActive = activateImmediately
            };

            if (MudDialog is not null)
                MudDialog.Close<HostReleaseInfo>(releaseInfo);
        }
        catch (Exception ex)
        {
            messages.Add($"An error occurred: {ex.Message}");
        }

        processing = false;
    }
}
