@page "/"
@using Daisi.Manager.Shared.Services

@inject IFormFactor FormFactor

<PageTitle>DAISI Manager</PageTitle>

<div class="row">
    <div class="col-12 col-md-8 py-4">
        @if (_loading)
        {
            <p>Loading dashboard...</p>
        }
        else
        {
            <h2 class="mb-4"><i class="fa-duotone fa-gauge-high me-2"></i> Dashboard</h2>

            @if (_accountName is not null)
            {
                <h5 class="text-muted mb-4">@_accountName</h5>
            }

            <div class="row g-3">
                @* Credit Balance *@
                <div class="col-6 col-lg-3">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <small class="text-muted">Credit Balance</small>
                            <h3 class="mt-1">@_balance.ToString("N0")</h3>
                        </div>
                    </div>
                </div>

                @* Total Earned *@
                <div class="col-6 col-lg-3">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <small class="text-muted">Total Earned</small>
                            <h3 class="mt-1 text-success">@_totalEarned.ToString("N0")</h3>
                        </div>
                    </div>
                </div>

                @* Total Spent *@
                <div class="col-6 col-lg-3">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <small class="text-muted">Total Spent</small>
                            <h3 class="mt-1 text-danger">@_totalSpent.ToString("N0")</h3>
                        </div>
                    </div>
                </div>

                @* Total Purchased *@
                <div class="col-6 col-lg-3">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <small class="text-muted">Total Purchased</small>
                            <h3 class="mt-1">@_totalPurchased.ToString("N0")</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-1">
                @* Hosts *@
                <div class="col-6 col-lg-4">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fa-duotone fa-server fa-2x text-muted mb-2"></i>
                            <div>
                                <h3 class="d-inline">@_hostsOnline</h3>
                                <small class="text-muted">/ @_hostsTotal</small>
                            </div>
                            <small class="text-muted">Hosts Online</small>
                        </div>
                        <div class="card-footer border-secondary text-center">
                            <a href="/hosts" class="text-decoration-none small">Manage Hosts</a>
                        </div>
                    </div>
                </div>

                @* Users *@
                <div class="col-6 col-lg-4">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fa-duotone fa-users fa-2x text-muted mb-2"></i>
                            <h3>@_userCount</h3>
                            <small class="text-muted">Users</small>
                        </div>
                        <div class="card-footer border-secondary text-center">
                            <a href="/account/manage/users" class="text-decoration-none small">Manage Users</a>
                        </div>
                    </div>
                </div>

                @* Apps *@
                <div class="col-6 col-lg-4">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fa-duotone fa-grid-2 fa-2x text-muted mb-2"></i>
                            <h3>@_appCount</h3>
                            <small class="text-muted">Apps</small>
                        </div>
                        <div class="card-footer border-secondary text-center">
                            <a href="/account/manage/apps" class="text-decoration-none small">Manage Apps</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-1">
                @* Multipliers *@
                <div class="col-12 col-lg-6">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-header border-secondary">
                            <i class="fa-duotone fa-gauge-high me-2"></i> Earn Multipliers
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-around text-center">
                                <div>
                                    <h3>@_tokenMultiplier.ToString("F1")x</h3>
                                    <small class="text-muted">Token</small>
                                </div>
                                <div>
                                    <h3>@_uptimeMultiplier.ToString("F1")x</h3>
                                    <small class="text-muted">Uptime</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @* Quick Actions *@
                <div class="col-12 col-lg-6">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-header border-secondary">
                            <i class="fa-duotone fa-bolt me-2"></i> Quick Actions
                        </div>
                        <div class="card-body d-flex flex-column gap-2">
                            <a class="btn btn-outline-primary" href="/hosts/setup">
                                <i class="fa-duotone fa-plus me-1"></i> Setup a Host
                            </a>
                            <a class="btn btn-outline-primary" href="https://daisi.ai/downloads" target="_blank">
                                <i class="fa-duotone fa-download me-1"></i> Download Daisi Bot
                            </a>
                            <a class="btn btn-outline-primary" href="/account/manage/credits">
                                <i class="fa-duotone fa-coins me-1"></i> View Credits
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="col bg-dark-subtle border-start py-4 vh-100">
        <h3 class="py-4">Need Some Help?</h3>
        <div class="border rounded p-4 bg-light-subtle mt-2">
            <h4 class="text-light"><i class="fa-duotone fa-book-sparkles"></i> Documentation</h4>
            <p>Learn more about how to use Daisi Manager and its features.</p>
            <a href="https://daisi.ai/learn/sdk" target="_blank" class="btn btn-outline-warning">Read Docs</a>
            <a href="https://github.com/daisinet" target="_blank" class="btn btn-outline-warning">Repos</a>
        </div>
        <div class="border rounded p-4 bg-light-subtle mt-4">
            <h4 class="text-light"><i class="fa-duotone fa-webhook"></i> SDK Access</h4>
            <p>Daisi was built to be used by developers! We have an SDK for DotNet. We have a path to produce them for Python and TypeScript as well. </p>
            <a href="https://daisi.ai/downloads" target="_blank" class="btn btn-outline-warning">Get An SDK</a>
        </div>
        <div class="border rounded p-4 bg-light-subtle mt-4">
            <h4 class="text-light"><i class="fa-duotone fa-newspaper"></i> News and Social Media</h4>
            <p>Keep up to date with everything going on in the DAISI network. Follow us!</p>
            <a href="https://daisi.ai/news" target="_blank" class="btn btn-outline-warning">Latest News</a>
            <a href="https://x.com/daisinet" target="_blank" class="btn btn-outline-warning"><i class="fa-brands fa-x-twitter"></i></a>
            <a href="https://linkedin.com/company/daisinet" target="_blank" class="btn btn-outline-warning"><i class="fa-brands fa-linkedin"></i></a>
        </div>
    </div>
</div>

@code {
    bool _loading = true;
    string? _accountName;

    long _balance;
    long _totalEarned;
    long _totalSpent;
    long _totalPurchased;
    double _tokenMultiplier = 1.0;
    double _uptimeMultiplier = 1.0;

    int _hostsOnline;
    int _hostsTotal;
    int _userCount;
    int _appCount;

    [Inject] AuthService AuthService { get; set; } = default!;
    [Inject] AccountClientFactory AccountClientFactory { get; set; } = default!;
    [Inject] CreditClientFactory CreditClientFactory { get; set; } = default!;
    [Inject] HostClientFactory HostClientFactory { get; set; } = default!;
    [Inject] DappClientFactory DappClientFactory { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var accountId = await AuthService.GetAccountIdAsync() ?? string.Empty;

            var accountClient = AccountClientFactory.Create();
            var creditClient = CreditClientFactory.Create();
            var hostClient = HostClientFactory.Create();
            var dappClient = DappClientFactory.Create();

            // Load account info
            var accountResponse = await accountClient.GetAsync(new GetAccountRequest());
            _accountName = accountResponse.Account?.Name;

            // Load credits
            try
            {
                var creditResponse = await creditClient.GetCreditAccountAsync(new GetCreditAccountRequest { AccountId = accountId });
                if (creditResponse.Account is not null)
                {
                    _balance = creditResponse.Account.Balance;
                    _totalEarned = creditResponse.Account.TotalEarned;
                    _totalSpent = creditResponse.Account.TotalSpent;
                    _totalPurchased = creditResponse.Account.TotalPurchased;
                    _tokenMultiplier = creditResponse.Account.TokenEarnMultiplier;
                    _uptimeMultiplier = creditResponse.Account.UptimeEarnMultiplier;
                }
            }
            catch { }

            // Load hosts
            try
            {
                var hostsResponse = await hostClient.GetHostsAsync(new GetHostsRequest
                {
                    Paging = new PagingInfo { PageSize = 100, PageIndex = 0 }
                });
                _hostsTotal = hostsResponse.TotalCount;
                _hostsOnline = hostsResponse.Hosts.Count(h => h.Status == HostStatus.Online);
            }
            catch { }

            // Load users
            try
            {
                var usersResponse = await accountClient.GetUsersAsync(new GetUsersRequest
                {
                    Paging = new PagingInfo { PageSize = 1, PageIndex = 0 }
                });
                _userCount = usersResponse.TotalCount;
            }
            catch { }

            // Load apps
            try
            {
                var appsResponse = await dappClient.GetAsync(new GetDappRequest
                {
                    Paging = new PagingInfo { PageSize = 1, PageIndex = 0 }
                });
                _appCount = appsResponse.TotalCount;
            }
            catch { }
        }
        catch { }
        finally
        {
            _loading = false;
        }
    }
}
