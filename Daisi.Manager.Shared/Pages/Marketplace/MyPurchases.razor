@using Daisi.Manager.Shared.Services

<div>
    <h4>My Purchases</h4>

    @if (_loading)
    {
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_purchases.Count == 0)
    {
        <div class="alert alert-info mt-3">
            <i class="fa-duotone fa-info-circle me-1"></i> You haven't purchased any marketplace items yet.
            <a href="/marketplace" class="alert-link">Browse the marketplace</a> to find skills, tools, and plugins.
        </div>
    }
    else
    {
        <div class="table-responsive mt-3">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Type</th>
                        <th>Credits Paid</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var purchase in _purchases)
                    {
                        <tr role="button" @onclick="() => ViewItem(purchase.MarketplaceItemId)">
                            <td>
                                <strong>@purchase.MarketplaceItemName</strong>
                            </td>
                            <td>
                                <span class="badge @GetTypeBadge(purchase.ItemType)">@GetTypeLabel(purchase.ItemType)</span>
                            </td>
                            <td>
                                @if (purchase.CreditsPaid == 0)
                                {
                                    <span class="text-success">Free</span>
                                }
                                else
                                {
                                    <span>@purchase.CreditsPaid credits</span>
                                    @if (purchase.IsSubscription)
                                    {
                                        <small class="text-muted">/period</small>
                                    }
                                }
                            </td>
                            <td>@purchase.PurchasedAt.ToDateTime().ToString("MMM d, yyyy")</td>
                            <td>
                                @if (purchase.IsSubscription)
                                {
                                    if (purchase.IsActive && purchase.SubscriptionExpiresAt is not null
                                        && purchase.SubscriptionExpiresAt.ToDateTime() > DateTime.UtcNow)
                                    {
                                        <span class="badge bg-success">Active</span>
                                        <small class="text-muted ms-1">
                                            Renews @purchase.SubscriptionExpiresAt.ToDateTime().ToString("MMM d")
                                        </small>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Expired</span>
                                    }
                                }
                                else
                                {
                                    <span class="badge bg-success">Owned</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    [Inject] public MarketplaceClientFactory MarketplaceClientFactory { get; set; } = default!;
    [Inject] public AuthService AuthService { get; set; } = default!;
    [Inject] public NavigationManager NavigationManager { get; set; } = default!;

    private List<MarketplacePurchaseInfo> _purchases = [];
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var accountId = await AuthService.GetAccountIdAsync() ?? string.Empty;
            if (!string.IsNullOrEmpty(accountId))
            {
                var client = MarketplaceClientFactory.Create();
                var response = await client.GetMyPurchasesAsync(new GetMyPurchasesRequest { AccountId = accountId });
                _purchases = response.Purchases.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading purchases: {ex.Message}");
        }
        _loading = false;
    }

    private void ViewItem(string itemId)
    {
        NavigationManager.NavigateTo($"/marketplace/item/{itemId}");
    }

    private static string GetTypeBadge(MarketplaceItemType type) => type switch
    {
        MarketplaceItemType.Skill => "bg-info",
        MarketplaceItemType.BotTool => "bg-primary",
        MarketplaceItemType.HostTool => "bg-warning text-dark",
        MarketplaceItemType.Plugin => "bg-success",
        _ => "bg-secondary"
    };

    private static string GetTypeLabel(MarketplaceItemType type) => type switch
    {
        MarketplaceItemType.Skill => "Skill",
        MarketplaceItemType.BotTool => "Bot Tool",
        MarketplaceItemType.HostTool => "Host Tool",
        MarketplaceItemType.Plugin => "Plugin",
        _ => "Unknown"
    };
}
