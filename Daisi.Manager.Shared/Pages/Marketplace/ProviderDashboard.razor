@using Daisi.Manager.Shared.Services

<div>
    @if (_loading)
    {
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_profile is null)
    {
        <div class="card bg-dark-subtle border-secondary mt-3">
            <div class="card-body text-center py-5">
                <i class="fa-duotone fa-store fa-3x mb-3 text-warning"></i>
                <h4>Become a Provider</h4>
                <p class="text-muted">Publish skills, tools, and plugins on the DAISI Marketplace and earn credits.</p>

                <div class="row justify-content-center mt-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Display Name *</label>
                            <input type="text" class="form-control" @bind="_newDisplayName" maxlength="50" />
                            <small class="text-muted">3-50 characters. Cannot contain "daisi" or "daisinet".</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Bio</label>
                            <textarea class="form-control" rows="3" @bind="_newBio"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Website URL</label>
                            <input type="url" class="form-control" @bind="_newWebsiteUrl" />
                        </div>
                        <button class="btn btn-warning" @onclick="CreateProfileAsync" disabled="@_saving">
                            @if (_saving)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="fa-duotone fa-rocket me-1"></i> Apply to Become a Provider
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="card bg-dark-subtle border-secondary">
                    <div class="card-body">
                        <h5>Provider Profile</h5>
                        <span class="badge @GetStatusBadge(_profile.Status) mb-2">@_profile.Status</span>

                        <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Display Name</label>
                            <input type="text" class="form-control form-control-sm" @bind="_profile.DisplayName" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Bio</label>
                            <textarea class="form-control form-control-sm" rows="2" @bind="_profile.Bio"></textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label small text-muted mb-0">Website</label>
                            <input type="url" class="form-control form-control-sm" @bind="_profile.WebsiteUrl" />
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" @onclick="UpdateProfileAsync" disabled="@_saving">
                            Save Profile
                        </button>
                    </div>
                </div>

                <div class="card bg-dark-subtle border-secondary mt-3">
                    <div class="card-body">
                        <h6 class="text-muted mb-3">Revenue</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Earnings</span>
                            <strong>@_profile.TotalEarnings credits</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Pending Payout</span>
                            <strong>@_profile.PendingPayout credits</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Revenue Share</span>
                            <strong>@_profile.RevenueSharePercent%</strong>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Your Items (@_items.Count)</h5>
                    <a href="/marketplace/edit" class="btn btn-sm btn-warning">
                        <i class="fa-duotone fa-plus me-1"></i> New Item
                    </a>
                </div>

                @if (_items.Count == 0)
                {
                    <div class="alert alert-info">
                        You haven't published any items yet. Click "New Item" to get started.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Price</th>
                                    <th>Purchases</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in _items)
                                {
                                    <tr>
                                        <td><strong>@item.Name</strong> <small class="text-muted">v@item.Version</small></td>
                                        <td><span class="badge @GetTypeBadge(item.ItemType)">@GetTypeLabel(item.ItemType)</span></td>
                                        <td><span class="badge @GetItemStatusBadge(item.Status)">@item.Status</span></td>
                                        <td>@GetPriceLabel(item)</td>
                                        <td>@item.PurchaseCount</td>
                                        <td>
                                            <a href="/marketplace/edit/@item.Id" class="btn btn-sm btn-outline-secondary">
                                                <i class="fa-duotone fa-pen"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Inject] public MarketplaceClientFactory MarketplaceClientFactory { get; set; } = default!;
    [Inject] public AuthService AuthService { get; set; } = default!;
    [Inject] public IToastService ToastService { get; set; } = default!;

    private ProviderProfileInfo? _profile;
    private List<MarketplaceItemInfo> _items = [];
    private bool _loading = true;
    private bool _saving;

    private string _newDisplayName = string.Empty;
    private string _newBio = string.Empty;
    private string _newWebsiteUrl = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var accountId = await AuthService.GetAccountIdAsync() ?? string.Empty;
            if (string.IsNullOrEmpty(accountId)) return;

            var client = MarketplaceClientFactory.Create();

            var profileResponse = await client.GetProviderProfileAsync(new GetProviderProfileRequest { AccountId = accountId });
            _profile = profileResponse.Profile;

            if (_profile is not null)
            {
                var browseResponse = await client.BrowseMarketplaceAsync(new BrowseMarketplaceRequest());
                // Filter to this provider's items â€” the browse returns all public items,
                // but for provider dashboard we need the provider's own items
                // TODO: Add a GetMarketplaceItemsByAccount RPC for provider dashboard
                _items = browseResponse.Items.Where(i => i.AccountId == accountId).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading provider dashboard: {ex.Message}");
        }
        _loading = false;
    }

    private static bool ContainsReservedName(string name) =>
        System.Text.RegularExpressions.Regex.IsMatch(name, @"\bdaisi(net)?\b", System.Text.RegularExpressions.RegexOptions.IgnoreCase);

    private async Task CreateProfileAsync()
    {
        if (string.IsNullOrWhiteSpace(_newDisplayName))
        {
            ToastService.ShowWarning("Display name is required.");
            return;
        }

        if (_newDisplayName.Trim().Length < 3 || _newDisplayName.Trim().Length > 50)
        {
            ToastService.ShowWarning("Display name must be between 3 and 50 characters.");
            return;
        }

        if (ContainsReservedName(_newDisplayName))
        {
            ToastService.ShowWarning("Display name cannot contain 'daisi' or 'daisinet'. These names are reserved.");
            return;
        }

        _saving = true;
        try
        {
            var accountId = await AuthService.GetAccountIdAsync() ?? string.Empty;
            var client = MarketplaceClientFactory.Create();
            var response = await client.CreateProviderProfileAsync(new CreateProviderProfileRequest
            {
                Profile = new ProviderProfileInfo
                {
                    AccountId = accountId,
                    DisplayName = _newDisplayName,
                    Bio = _newBio,
                    WebsiteUrl = _newWebsiteUrl
                }
            });
            _profile = response.Profile;
            ToastService.ShowSuccess("Provider application submitted! An admin will review your profile.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        _saving = false;
    }

    private async Task UpdateProfileAsync()
    {
        if (_profile is not null && ContainsReservedName(_profile.DisplayName))
        {
            ToastService.ShowWarning("Display name cannot contain 'daisi' or 'daisinet'. These names are reserved.");
            return;
        }

        _saving = true;
        try
        {
            var client = MarketplaceClientFactory.Create();
            var response = await client.UpdateProviderProfileAsync(new UpdateProviderProfileRequest { Profile = _profile });
            _profile = response.Profile;
            ToastService.ShowSuccess("Profile updated.");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error: {ex.Message}");
        }
        _saving = false;
    }

    private static string GetStatusBadge(string status) => status switch
    {
        "Pending" => "bg-warning text-dark",
        "Approved" => "bg-success",
        "Suspended" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetTypeBadge(MarketplaceItemType type) => type switch
    {
        MarketplaceItemType.Skill => "bg-info",
        MarketplaceItemType.BotTool => "bg-primary",
        MarketplaceItemType.HostTool => "bg-warning text-dark",
        MarketplaceItemType.Plugin => "bg-success",
        _ => "bg-secondary"
    };

    private static string GetTypeLabel(MarketplaceItemType type) => type switch
    {
        MarketplaceItemType.Skill => "Skill",
        MarketplaceItemType.BotTool => "Bot Tool",
        MarketplaceItemType.HostTool => "Host Tool",
        MarketplaceItemType.Plugin => "Plugin",
        _ => "Unknown"
    };

    private static string GetItemStatusBadge(string status) => status switch
    {
        "Draft" => "bg-secondary",
        "PendingReview" => "bg-warning text-dark",
        "AutoTested" => "bg-info",
        "Approved" => "bg-success",
        "Rejected" => "bg-danger",
        "Suspended" => "bg-danger",
        _ => "bg-secondary"
    };

    private static string GetPriceLabel(MarketplaceItemInfo item) => item.PricingModel switch
    {
        MarketplacePricingModel.MarketplacePricingFree => "Free",
        MarketplacePricingModel.MarketplacePricingOneTime => $"{item.CreditPrice} credits",
        MarketplacePricingModel.MarketplacePricingSubscription => $"{item.SubscriptionCreditPrice} cr/mo",
        _ => "Free"
    };
}
